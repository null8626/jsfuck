EXTRA_CFLAGS=
EXTRA_LFLAGS=

CFLAGS=/O2 /MD /I include /DJSFUCK_SOURCE /D_CRT_SECURE_NO_WARNINGS $(EXTRA_CFLAGS)
LFLAGS=/MACHINE:x64 $(EXTRA_LFLAGS)

!if "$(SHARED)" == "yes"
LIB_FILES=jsfuck.lib jsfuck.dll
TRANSPILER_LIB=jsfuck.lib
CFLAGS=$(CFLAGS) /D JSFUCK_DLL
!else
LIB_FILES=jsfuck_s.lib
TRANSPILER_LIB=$(LIB_FILES)
!endif

jsfuck.exe: $(LIB_FILES)
	llvm-rc.exe /n /d JSFUCK_TRANSPILER /fo jsfuck_transpiler.res jsfuck.rc
	clang-cl.exe $(CFLAGS) /Fejsfuck.exe src/transpiler/transpiler.c src/transpiler/io.c $(TRANSPILER_LIB) jsfuck_transpiler.res /link $(LFLAGS)

jsfuck.lib jsfuck.dll:
	llvm-rc.exe /n /fo jsfuck_dll.res jsfuck.rc
	clang-cl.exe /LD $(CFLAGS) /Fe"jsfuck.dll" src/jsfuck.c src/stream.c src/token.c src/common.c jsfuck_dll.res

jsfuck_s.lib: jsfuck.obj stream.obj token.obj common.obj
	llvm-lib.exe $(LFLAGS) /OUT:jsfuck_s.lib $?

jsfuck.obj: src/jsfuck.c
	clang-cl.exe $(CFLAGS) /c %s

stream.obj: src/stream.c
	clang-cl.exe $(CFLAGS) /c %s

token.obj: src/token.c
	clang-cl.exe $(CFLAGS) /c %s

common.obj: src/common.c
	clang-cl.exe $(CFLAGS) /c %s